{% extends "base.html" %}

{% block head %}
{{ super() }}
{% endblock %}

{% block scripts %}
{{ super() }}
<script type="text/javascript" src="{{ url_for('static', filename='sunburst.js') }}"></script>
<script src="https://d3js.org/d3.v5.min.js"></script>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script id="sunburst-chart-creation">
  (async function() {

    // get endpoint parameter and mirror in form field
    const urlParams = await new URLSearchParams(window.location.search);
    const endpoint = await urlParams.get('endpoint');
    const formField = await $('#endpoint-field')
    await formField.val(endpoint)

    // make Form submit redirect with new endpoint parameter but keep other params
    await $('#set-endpoint').submit(async (event) => {
      await event.preventDefault()
      await urlParams.set('endpoint', formField.val())
      await console.log(urlParams.toString())
      window.location.href = window.location.origin + window.location.pathname + '?' + urlParams.toString()
    })
    
    const errorAlert = await $('#sunburst-error')
    await errorAlert.hide()
    // loading screen is shown by default
    const infoBox = await $('#sunburst-loading');
    await infoBox.show()

    try {
      const res = await getNodeData(endpoint)
      await new Promise(r => setTimeout(r, 4000));
      const nodeData = await parseCSV(res)
    
      const chart = Sunburst(nodeData, {
        value: d => d.size, // size of each node (file); null for internal nodes (folders)
        label: d => d.name.length <= 6 ? d.name : d.name.substring(0, 6)+'...', // display name for each cell
        title: (d, n) => `${n.ancestors().reverse().map(d => d.data.name).join(".")}\n${n.value.toLocaleString("en")}`, // hover text
        // link_url = query_url.searchParams.set('sparklis-query','test'),
        link: (d, n) => `${query_url.toString()}&sparklis-query=%5BVId%5DReturn%28Det%28An%281%2CModif%28Select%2CUnordered%29%2CClass%28%22${encodeURIComponent(d.iri)}%22%29%29%2CNone%29%29`,
        width: 900,
        height: 900,
      });

      const svg = await $("#sunburst");
      svg.append(chart)

      // svg.replaceWith(chart);
      const responsive_sunburst = await $("#sunburst"),
      aspect = responsive_sunburst.width() / responsive_sunburst.height(),
      container = responsive_sunburst.parent();
      
      // make sunburst responsive
      await $(window).on("resize", function() {
          var targetHeight = container.height();
          responsive_sunburst.attr("height", targetHeight);
          responsive_sunburst.attr("width", Math.round(targetHeight * aspect));
      }).trigger("resize");

    } catch(e) {
      errorAlert.text(e)
      console.log(e)
      errorAlert.show()
    } finally {
      // sunburst is done, hide loading screen here
      await infoBox.hide()
    }

    
  })();
</script>
{% endblock %}

{% block main %}
	<form id="set-endpoint">
		<div class="input-group mb-3">
			<input id="endpoint-field" value="" name="endpoint" class="form-control no-padding" type="url">
		  <div class="input-group-append">
			<button type="submit" id="sparql-endpoint-button" class="btn btn-primary">Set endpoint</button>
		  </div>
		</div>
	</form>

    <!-- <meta id="sunburst_data" data-nodes="{{ sunburst_data }}"> -->
    <div class="alert alert-info" id="sunburst-loading" role="alert">
      Loading overview data...
    </div>
    <div class="alert alert-danger" id="sunburst-error" role="alert">
      
    </div>
    <svg class="img-fluid" height="100%" id="sunburst" viewBox="0 170 850 620"></svg>
{% endblock %}


