{% extends "base.html" %}

{% block head %}
{{ super() }}
<script type="text/javascript" src="{{ url_for('static', filename='sunburst.js') }}"></script>
<script src="https://d3js.org/d3.v5.min.js"></script>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>

  function filterNodesById(nodes, id) {
    return nodes.filter(function (n) { return n.id === id; });
  }

  function triplesToGraph(triples) {

    svg.html("");
    //Graph
    var graph = { nodes: [], links: [] };

    //Initial Graph from triples
    triples.forEach(function (triple) {
      var subjId = triple.subject;
      var predId = triple.predicate;
      var objId = triple.object;

      var subjNode = filterNodesById(graph.nodes, subjId)[0];
      var objNode = filterNodesById(graph.nodes, objId)[0];

      if (subjNode == null) {
        subjNode = { id: subjId, label: subjId, weight: 1 };
        graph.nodes.push(subjNode);
      }

      if (objNode == null) {
        objNode = { id: objId, label: objId, weight: 1 };
        graph.nodes.push(objNode);
      }


      graph.links.push({ source: subjNode, target: objNode, predicate: predId, weight: 1 });
    });

    return graph;
  }
</script>
{% endblock %}

{% block main %}
	<form action="/">
		<div class="input-group mb-3">
			<input id="sparql-endpoint-input" value="{{ endpoint }}" name="sparql-endpoint-input" class="form-control no-padding" type="url">
		  <div class="input-group-append">
			<button type="submit" id="sparql-endpoint-button" class="btn btn-primary">Apply SPARQL endpoint!</button>
		  </div>
		</div>
	</form>

    <!-- <meta id="sunburst_data" data-nodes="{{ sunburst_data }}"> -->
    <div class="alert alert-info" id="sunburst-loading" role="alert">
      Loading overview data...
    </div>
    <svg class="img-fluid" height="100%" id="sunburst" viewBox="0 170 850 620"></svg>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
  (async function() {
    var endpoint = "http://localhost:3030/test/"
    
    // loading screen is shown by default
    infoBox = $('#sunburst-loading');

    var nodeData = await getNodeData(endpoint)

    console.log(nodeData)
    
    chart = Sunburst(parseCSV(nodeData), {
      value: d => d.size, // size of each node (file); null for internal nodes (folders)
      label: d => d.name.length <= 6 ? d.name : d.name.substring(0, 6)+'...', // display name for each cell
      title: (d, n) => `${n.ancestors().reverse().map(d => d.data.name).join(".")}\n${n.value.toLocaleString("en")}`, // hover text
      // link_url = query_url.searchParams.set('sparklis-query','test'),
      link: (d, n) => `${query_url.toString()}&sparklis-query=%5BVId%5DReturn%28Det%28An%281%2CModif%28Select%2CUnordered%29%2CClass%28%22${encodeURIComponent(d.iri)}%22%29%29%2CNone%29%29`,
      width: 900,
      height: 900,
    });

    svg = $("#sunburst");
    svg.append(chart)

    // svg.replaceWith(chart);
    var responsive_sunburst = $("#sunburst"),
    aspect = responsive_sunburst.width() / responsive_sunburst.height(),
    container = responsive_sunburst.parent();
    
    // make sunburst responsive
    $(window).on("resize", function() {
        var targetHeight = container.height();
        responsive_sunburst.attr("height", targetHeight);
        responsive_sunburst.attr("width", Math.round(targetHeight * aspect));
    }).trigger("resize");

    // sunburst is done, hide loading screen here
    infoBox.hide()
  })();
</script>
{% endblock %}
